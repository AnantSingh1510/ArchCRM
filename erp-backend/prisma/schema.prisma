// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String    @id @default(cuid())
  username        String    @unique
  email           String    @unique
  name            String?
  phone           String?
  password        String
  role            Role      @default(USER)
  active          Boolean   @default(true)
  projects        Project[]
  tasks           Task[]
  approvals       Approval[]
  client          Client?   @relation(fields: [clientId], references: [id])
  clientId        String?   @unique
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  salesBookings   Booking[] @relation("SalesEmployeeBookings")
  brokerBookings  Booking[] @relation("BrokerBookings")

  @@map("user")
}

model Project {
  id          String        @id @default(cuid())
  name        String
  clients     ClientsOnProjects[]
  location    String
  startDate   DateTime?
  endDate     DateTime?
  status      ProjectStatus @default(PLANNING)
  progress    Int           @default(0)
  phases      Phase[]
  members     User[]
  properties  Property[]
  photos      String[]
  bookings    Booking[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("project")
}

model Phase {
  id          String   @id @default(cuid())
  name        String
  project     Project  @relation(fields: [projectId], references: [id])
  projectId   String
  tasks       Task[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("phase")
}

model Task {
  id          String   @id @default(cuid())
  name        String
  description String?
  status      Status   @default(PENDING)
  priority    Priority @default(MEDIUM)
  dueDate     DateTime
  phase       Phase    @relation(fields: [phaseId], references: [id])
  phaseId     String
  assignee    User?    @relation(fields: [assigneeId], references: [id])
  assigneeId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("task")
}

enum Role {
  USER
  ADMIN
  OWNER
  EMPLOYEE
}

enum Status {
  PENDING
  IN_PROGRESS
  IN_REVIEW
  DONE
}

enum Priority {
  HIGH
  MEDIUM
  LOW
}

enum ProjectStatus {
  PLANNING
  IN_PROGRESS
  COMPLETED
}

model Client {
  id                  String    @id @default(cuid())
  name                String
  email               String    @unique
  phone               String
  alternatePhone      String?
  joinedDate          DateTime?
  
  // Applicant Details
  title               String?
  firstName           String?
  middleName          String?
  lastName            String?
  relationName        String?
  dob                 DateTime?
  anniversaryDate     DateTime?
  nationality         String?
  maritalStatus       String?
  gender              String?
  children            Int?
  passportNo          String?
  panNumber           String?
  aadhaarNumber       String?
  profession          String?
  designation         String?
  company             String?

  // Bank Details
  bankAccountNumber   String?
  ifscCode            String?
  bankName            String?
  bankBranch          String?

  // Address Details (as JSON for simplicity)
  presentAddress      Json?
  officeAddress       Json?
  permanentAddress    Json?
  mailingAddress      String?
  communicationPreference String?

  // System Fields
  status              String    @default("ACTIVE")
  kycStatus           String    @default("PENDING")
  
  // Relations
  projects            ClientsOnProjects[]
  invoices            Invoice[]
  documents           Document[]
  user                User?
  properties          Property[]
  communications      Communication[]
  payments            Payment[]
  bookings            Booking[]
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@map("client")
}

model Property {
  id          String         @id @default(cuid())
  plotNumber  String?
  dimensions  String?
  location    String?
  tower       String?
  floor       String?
  unitNumber  String?
  area        Float?
  orientation String?
  totalAmount Float?
  type        PropertyType   @default(RESIDENTIAL)
  status      PropertyStatus @default(AVAILABLE)
  project     Project        @relation(fields: [projectId], references: [id])
  projectId   String
  client      Client         @relation(fields: [clientId], references: [id])
  clientId    String
  bookings    Booking[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("property")
}

model ClientsOnProjects {
  project   Project @relation(fields: [projectId], references: [id])
  projectId String
  client    Client  @relation(fields: [clientId], references: [id])
  clientId  String

  @@id([projectId, clientId])
}

enum PropertyType {
  RESIDENTIAL
  COMMERCIAL
  INDUSTRIAL
  LAND
}

enum PropertyStatus {
  AVAILABLE
  SOLD
  RESERVED
}

model Invoice {
  id          String    @id @default(cuid())
  client      Client    @relation(fields: [clientId], references: [id])
  clientId    String
  amount      Float
  date        DateTime
  dueDate     DateTime
  status      String    @default("PENDING")
  description String?
  payments    Payment[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("invoice")
}

model Approval {
  id          String   @id @default(cuid())
  type        String
  status      String   @default("PENDING")
  requester   User     @relation(fields: [requesterId], references: [id])
  requesterId String
  data        Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("approval")
}

model Document {
  id           String   @id @default(cuid())
  name         String
  type         String
  status       String
  tags         String[]
  uploadedDate DateTime
  uploadedBy   String
  expiryDate   DateTime?
  size         String
  url          String
  clientId     String
  client       Client   @relation(fields: [clientId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("document")
}

model Communication {
  id        String   @id @default(cuid())
  type      String
  subject   String
  message   String
  date      DateTime
  client    Client   @relation(fields: [clientId], references: [id])
  clientId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("communication")
}

model Payment {
  id          String   @id @default(cuid())
  amount      Float
  date        DateTime
  status      String   @default("PENDING")
  description String?
  client      Client   @relation(fields: [clientId], references: [id])
  clientId    String
  invoice     Invoice? @relation(fields: [invoiceId], references: [id])
  invoiceId   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("payment")
}

model Booking {
  id                      String                 @id @default(cuid())
  unitHolderType          UnitHolderType
  project                 Project                @relation(fields: [projectId], references: [id])
  projectId               String
  unitType                PropertyType
  customerClassification  CustomerClassification
  broker                  User?                  @relation("BrokerBookings", fields: [brokerId], references: [id])
  brokerId                String?
  bookingType             BookingType
  paymentPlan             String // This might need to be a separate model later
  applicationDate         DateTime
  basicPrice              Float
  formNo                  String?
  registrationNo          String?
  gstin                   String?
  companyDiscount         Json? // Storing discounts as JSON for flexibility
  brokerDiscount          Json?
  client                  Client                 @relation(fields: [clientId], references: [id])
  clientId                String
  property                Property               @relation(fields: [propertyId], references: [id])
  propertyId              String
  salesEmployee           User                   @relation("SalesEmployeeBookings", fields: [salesEmployeeId], references: [id])
  salesEmployeeId         String
  remarks                 String?
  otherCosts              Json?
  finance                 Json?
  nomineeDetails          Json?
  status                  BookingStatus          @default(PENDING)
  createdAt               DateTime               @default(now())
  updatedAt               DateTime               @updatedAt

  @@map("booking")
}

enum UnitHolderType {
  INDIVIDUAL
  MULTIPLE
  COMPANY
}

enum CustomerClassification {
  BROKER
  DIRECT
}

enum BookingType {
  NORMAL
  HOLD
}

enum BookingStatus {
  PENDING
  APPROVED
  CANCELLED
}
